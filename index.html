<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bon de cession - Signature</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f6f8fa; text-align: center; margin-top: 40px; }
    h1 { color: #1976d2; }
    form { display: inline-block; background: #fff; border: 2px solid #1976d2; border-radius: 12px; padding: 25px 30px; box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 90%; max-width: 560px; text-align: left; }
    label { display: block; margin-top: 10px; color: #333; }
    input { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 5px; margin-top: 4px; }
    #signature-pad { border: 2px solid #1976d2; border-radius: 8px; display: block; margin: 20px auto; background-color: #fafafa; }
    button { margin: 5px; padding: 10px 20px; border: none; background-color: #1976d2; color: white; border-radius: 5px; cursor: pointer; }
    button:hover { background-color: #0d47a1; }
    #status { margin-top: 20px; font-weight: bold; text-align: center; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  </style>
</head>
<body>
  <h1>üñãÔ∏è Bon de cession</h1>

  <form id="form">
    <div id="no-client" style="text-align:center;">Aucun client pour le moment...</div>

    <div id="client-info" style="display:none;">
      <div class="row">
        <div>
          <label>Nom :</label>
          <input type="text" id="nom" name="nom" />
        </div>
        <div>
          <label>Pr√©nom :</label>
          <input type="text" id="prenom" name="prenom" />
        </div>
      </div>

      <label>Adresse :</label>
      <input type="text" id="adresse" name="adresse" />

      <div class="row">
        <div>
          <label>Code postal :</label>
          <input type="text" id="codePostal" name="codePostal" />
        </div>
        <div>
          <label>T√©l√©phone :</label>
          <input type="text" id="telephone" name="telephone" />
        </div>
      </div>

      <label>Email :</label>
      <input type="email" id="email" name="email" />

      <hr />

      <label>IMEI / S√©rie :</label>
      <input type="text" id="imei" name="imei" />

      <div class="row">
        <div>
          <label>Num√©ro CI :</label>
          <input type="text" id="numeroCI" name="numeroCI" />
        </div>
        <div>
          <label>Prix d'achat (‚Ç¨) :</label>
          <input type="text" id="prixAchat" name="prixAchat" />
        </div>
      </div>

      <label>Marque / Mod√®le :</label>
      <input type="text" id="marqueModele" name="marqueModele" />

      <div class="row">
        <div>
          <label>Attestation :</label>
          <input type="text" id="attestation" name="attestation" />
        </div>
        <div>
          <label>Date de cession :</label>
          <input type="text" id="dateCession" name="dateCession" />
        </div>
      </div>

      <p style="text-align:center; margin-top:15px;">Signature (pour PDF) :</p>
      <canvas id="signature-pad" width="320" height="160"></canvas>
      <div style="text-align:center;">
        <button type="button" onclick="clearPad()">Effacer la signature</button>
        <button type="button" onclick="saveOnly()">üíæ Enregistrer (sans PDF)</button>
        <button type="button" onclick="submitPad()">üñäÔ∏è Signer et valider (PDF)</button>
      </div>
    </div>

    <p id="status"></p>
  </form>

  <audio id="ding" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  <script>
    const SCRIPT_URL = "proxy.php";
    let pad = null;
    let currentId = null;

    // --- helpers
    function $(id) { return document.getElementById(id); }
    function fillForm(data) {
      for (const [k,v] of Object.entries(data)) {
        if ($(k)) $(k).value = v ?? '';
      }
    }

    async function loadById(id) {
      $('status').textContent = 'Chargement...';
      $('status').style.color = 'black';
      const r = await fetch(`${SCRIPT_URL}?id=${encodeURIComponent(id)}`);
      const j = await r.json();
      if (j.status === 'success') {
        currentId = id;
        $('no-client').style.display = 'none';
        $('client-info').style.display = 'block';
        fillForm(j.data);
        if (!pad) pad = new SignaturePad($('signature-pad'));
        $('status').textContent = '';
      } else {
        $('status').style.color = 'red';
        $('status').textContent = j.message || 'Erreur de chargement';
      }
    }

    // --- mode "en attente" (si pas d'id en query) : on garde ton polling existant
    async function checkClient() {
      try {
        const res = await fetch(`${SCRIPT_URL}?action=client&_=${Date.now()}`);
        const json = await res.json();
        if (json.status === "ok" && json.data) {
          const c = json.data;
          currentId = c.id;
          $('no-client').style.display = 'none';
          $('client-info').style.display = 'block';
          $('ding').play();
          fillForm(c);
          if (!pad) pad = new SignaturePad($('signature-pad'));
          $('status').textContent = '';
        } else {
          $('no-client').style.display = 'block';
          $('client-info').style.display = 'none';
        }
      } catch (e) { console.error(e); }
    }

    function clearPad() { if (pad) pad.clear(); }

    // --- Enregistrer sans PDF
// --- Enregistrer sans PDF
async function saveOnly() {
  if (!currentId) { alert('Aucun client charg√©'); return; }

  const statusEl = $('status');              // ‚Üê prends l'√©l√©ment, pas son textContent
  statusEl.textContent = 'Enregistrement...';
  statusEl.style.color = 'black';

  const formData = {};
  new FormData(document.getElementById('form')).forEach((v,k)=> formData[k]=v);
  formData.id = currentId;
  formData.mode = 'save';                     // ‚Üê sauvegarde sans PDF c√¥t√© Apps Script

  // on s‚Äôassure de ne PAS envoyer de signature en mode save
  delete formData.signature;

  try {
    const resp = await fetch(SCRIPT_URL, {    // ‚Üê utilise ta constante, pas "proxy.php" en dur
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(formData)
    });

    // on s√©curise le parsing JSON (au cas o√π)
    const text = await resp.text();
    let out;
    try { out = JSON.parse(text); }
    catch {
      statusEl.style.color = 'red';
      statusEl.textContent = 'R√©ponse non JSON du serveur (save).';
      console.error('RAW:', text);
      return;
    }

    if (out.status === 'success') {
      statusEl.style.color = 'green';
      statusEl.textContent = out.message || 'Donn√©es enregistr√©es (sans PDF) ‚úÖ';
    } else {
      statusEl.style.color = 'red';
      statusEl.textContent = out.message || 'Erreur c√¥t√© serveur';
    }
  } catch (err) {
    statusEl.style.color = 'red';
    statusEl.textContent = 'Erreur r√©seau : ' + err.message;
  }
}

    // --- Signer + PDF
    async function submitPad() {
      if (!pad || pad.isEmpty()) { alert('Veuillez signer avant de valider !'); return; }
      if (!currentId) { alert('Aucun client charg√© !'); return; }

      const formData = {};
      new FormData($('form')).forEach((v,k)=> formData[k]=v);
      formData.id = currentId;
      formData.signature = pad.toDataURL();

      $('status').textContent = 'Cr√©ation du PDF...';
      $('status').style.color = 'black';

      try {
        const response = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData)
        });
        const result = await response.json();
        if (result.status === "success") {
          $('status').style.color = "green";
          $('status').innerHTML = `‚úÖ ${result.message}<br><a href="${result.url}" target="_blank">Voir le PDF</a>`;
          pad.clear();
          // on peut vider le formulaire si besoin :
          // $('form').reset();
        } else {
          $('status').style.color = "red";
          $('status').textContent = "Erreur : " + result.message;
        }
      } catch (err) {
        $('status').style.color = "red";
        $('status').textContent = "Erreur d'envoi : " + err.message;
      }
    }

    // --- bootstrap : si ?id=... on charge direct, sinon polling
    (function init(){
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (id) {
        loadById(id);
      } else {
        setInterval(checkClient, 3000);
        checkClient();
      }
    })();
  </script>
</body>
</html>
